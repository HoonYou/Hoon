# 따릉이 정류소 이용률 감소 분석 – 접근 과정 정리

## 문제 접근 전략

이 문제를 풀면서 가장 먼저 잡은 원칙은  
**구할 수 있는 표를 하나씩 만들고, 한 발자국씩 전진한다**였다.

한 번에 모든 조건을 만족하는 쿼리를 작성하려고 하면
- 쿼리가 길어지고
- 디버깅이 어려워지며
- 성능 문제까지 같이 발생한다

그래서 `WITH` 구문을 활용해 **중간 결과 테이블을 단계적으로 생성**했다.

---

## 성능을 고려한 초기 필터링

데이터 규모가 약 **250,000행**이었기 때문에  
처음부터 전체 데이터를 들고 계산하는 것은 비효율적이라고 판단했다.

따라서:
- `WITH` 절 안에서
- **2018년 10월, 2019년 10월 데이터만**
- `WHERE` 조건으로 미리 필터링했다

이렇게 하니 이후 집계 단계에서의 부하를 크게 줄일 수 있었다.

---

## 가장 어려웠던 지점: 대여 & 반납 처리

이 문제에서 가장 헷갈렸던 부분은  
**대여(rent)와 반납(return)을 어떻게 다룰 것인가**였다.

처음에는:
- 대여 건수 집계
- 반납 건수 집계
- 마지막에 두 값을 더하는 방식

을 떠올렸지만, 이 방식은
- 쿼리가 불필요하게 길어지고
- 중복 로직이 많아진다는 문제가 있었다.

---

## 해결: 이벤트 기준으로 생각하기

접근 방식을 바꿨다.

- 대여와 반납은 **서로 다른 행위**지만
- 분석 관점에서는 둘 다 **“정류소에서 발생한 이벤트”**
- 발생 시간도 동일하게 하나의 `event_time`으로 볼 수 있다

그래서:
- 대여 / 반납을 따로 보지 않고
- `UNION ALL`로 합쳐
- **이벤트 단위로 정규화된 데이터**를 먼저 만들었다

이후에는 단순히:
- 같은 `station_id` 기준으로 묶어서
- 이벤트 수를 집계하면 되었다

이 과정을 거치자:
- 쿼리가 훨씬 깔끔해졌고
- 실행 시간이 **약 54초 → 5초 이내**로 크게 줄었다

---

## 조건부 집계로 기간 비교

이벤트를 정규화한 이후에는  
**조건부 집계(Conditional Aggregation)** 방식으로 넘어갔다.

```sql
SUM(CASE WHEN 조건 THEN 1 ELSE 0 END)
